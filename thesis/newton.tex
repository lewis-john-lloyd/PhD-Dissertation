\chapter{Newton Steps}
\label{app:newton}

 Linearization of the axial momentum equations in COBRA-IE.

\begin{IEEEeqnarray}{rCl}
  \vec{x}_k & = \begin{bmatrix}
   \dot{\vec{M}}_k \\
   \Delta \text{P}_k
 \end{bmatrix}\ & = \begin{bmatrix}
 \dot{M}_{l,k}\\
 \dot{M}_{g,k}\\
 \dot{M}_{e,k}\\
 \Delta \text{P}_{k}
 \end{bmatrix}
 \end{IEEEeqnarray}

 Note: 

 \begin{IEEEeqnarray}{rCCCr}
 \vec{L}(\vec{x}_{k}) & = & \mat{L}\;\dot{\vec{M}}_{k} + \vec{b}\Delta\text{P}_{k} \nonumber \\
 \frac{\partial}{\partial \Delta\text{P}_{k}}\left[\vec{b} \Delta \text{P}_{k}\right] & = & \vec{b} \nonumber \\
 \frac{\partial\; \vec{N}(\vec{x}_{k})}{\partial \vec{x}_{k}} & = & \frac{\partial\; \vec{N}(\vec{x}_{k})}{\partial \dot{\vec{M}}_{k}} & = & \mat{N}(\dot{\vec{M}}_{k}) \nonumber \\
 \mat{J}^{*}_{k} & = & \frac{\partial\; \vec{F}(\vec{x}_{k})}{\partial \dot{\vec{M}_{k}}} & = & \mat{L} + \mat{N}(\dot{\vec{M}}_{k})  \nonumber \\
 \mat{J}_{\,k}\delta \vec{x} & = & \frac{\partial\; \vec{F}(\vec{x}_{k})}{\partial \vec{x}_{k}}\delta\vec{x} & = & \mat{J}^{*}_{\,k}\delta(\dot{\vec{M}}) + \vec{b}\delta(\Delta \text{P})\nonumber
 \end{IEEEeqnarray}



Current View Point

\begin{IEEEeqnarray}{rCl}
 0 & = & \vec{F}(\vec{x}_{k+1}) \nonumber \\
 0 & = & \vec{F}(\vec{x}_{k+1}) =  \vec{E} + \vec{L}(\vec{x}_{k+1}) + \vec{N}(\vec{x}_{k+1})  \nonumber \\
 0 & = & \vec{E} + \vec{L}(\vec{x}_{k+1}) + \vec{N}(\vec{x}_{k+1}) \nonumber \\
 0 & = & \vec{E} + \mat{L}\;\dot{\vec{M}}_{k+1} + \vec{b}\Delta\text{P}_{k+1} + \vec{N}(\vec{x}_{k+1}) \nonumber \\
 0 & = & \vec{E} + \mat{L}\;\dot{\vec{M}}_{k+1} + \vec{b}\Delta \text{P}_{k} + \frac{\partial\left[ \vec{b}\Delta\text{P}_{k+1}\right]}{\partial\,\Delta \text{P}_{k+1}}\delta(\Delta \text{P}) + \vec{N}(\vec{x}_{k}) + \frac{\partial \left[ \vec{N}(\vec{x}_{k+1})\right]}{\partial\, \vec{x}_{k+1}}\left[\vec{x}_{k+1}-\vec{x}_{k}\right] \nonumber
 \end{IEEEeqnarray}

 \begin{IEEEeqnarray}{rCl}
  \mat{L}\;\dot{\vec{M}}_{k+1} + \mat{N}(\dot{\vec{M}}_{k})\;\dot{\vec{M}}_{k+1} & = & -\vec{E} - \vec{b}\Delta \text{P}_{k} - \vec{N}(\vec{x}_{k}) - \vec{b}\delta(\Delta \text{P}) + \mat{N}(\dot{\vec{M}}_{k})\dot{\vec{M}}_{k} \nonumber \\
  \left[\mat{L} + \mat{N}(\dot{\vec{M}}_{k})\right]\dot{\vec{M}}_{k+1} & = & - \left[\vec{E} + \vec{b}\Delta \text{P}_{k} + \vec{N}(\vec{x}_{k}) - \mat{N}(\dot{\vec{M}}_{k})\;\dot{\vec{M}}_{k}\right] - \vec{b}\delta(\Delta \text{P}) \nonumber \\
  \mat{J}^{*}_{\,k}\; \dot{\vec{M}}_{k+1} & = &  -\vec{f} - \vec{b}\delta(\Delta \text{P}) \nonumber \\
 \dot{\vec{M}}_{k+1} & = &  \underbrace{-\mat{J}_{\,k}^{-*}\;\vec{f}}_{\dot{\vec{M}}^{\widetilde{n+1}}_{\,k}} \underbrace{- \mat{J}^{-*}_{\,k}\;\vec{b}}_{\frac{d \dot{\vec{M}}_{k}}{d \Delta \text{P}}}\delta(\Delta \text{P}) \nonumber \\
 \dot{\vec{M}}_{k+1} & = &  \dot{\vec{M}}^{\widetilde{n+1}}_{\,k} + \frac{d \dot{\vec{M}}_{k}}{d \Delta \text{P}}\delta(\Delta \text{P}) \nonumber 
 \end{IEEEeqnarray}

Relation between Newton step and current formulation.

 \begin{IEEEeqnarray}{rCl}
 \left[\mat{L} + \mat{N}(\dot{\vec{M}}_{k})\right]\dot{\vec{M}}_{k+1} & = & - \left[\vec{E} + \mat{L}\;\dot{\vec{M}}_{k} + \vec{b}\Delta \text{P}_{k} + \vec{N}(\vec{x}_{k}) \right] \nonumber \\
 & & - \vec{b}\delta(\Delta \text{P}) + \mat{L}\;\dot{\vec{M}}_{k} + \mat{N}(\dot{\vec{M}}_{k})\;\dot{\vec{M}}_{k} \nonumber \\
 \left[\mat{L} + \mat{N}(\dot{\vec{M}}_{k})\right]\dot{\vec{M}}_{k+1} & = & - \vec{F}(\vec{x}_{k}) - \vec{b}\delta(\Delta \text{P}) + \left[\mat{L} + \mat{N}(\dot{\vec{M}}_{k})\right]\;\dot{\vec{M}}_{k} \nonumber \\
 \mat{J}^{*}_{\,k}\,\dot{\vec{M}}_{k+1} & = & - \vec{F}(\vec{x}_{k}) - \vec{b}\delta(\Delta \text{P}) + \mat{J}^{*}_{\,k}\;\dot{\vec{M}}_{k} \nonumber \\
 \dot{\vec{M}}_{k+1} & = & \underbrace{\dot{\vec{M}}_{k} - \mat{J}_{\,k}^{-*} \vec{F}(\vec{x}_{k})}_{\dot{\vec{M}}^{\widetilde{n+1}}_{\,k}} \underbrace{- \mat{J}_{\,k}^{-1}\vec{b}}_{\frac{d \dot{\vec{M}}_{k}}{d \Delta \text{P}}}\delta\text{P} \nonumber \\
 \dot{\vec{M}}_{k+1} & = &  \dot{\vec{M}}^{\widetilde{n+1}}_{\,k} + \frac{d \dot{\vec{M}}_{k}}{d \Delta \text{P}}\delta(\Delta \text{P}) \nonumber 
 \end{IEEEeqnarray}


Equivalence with a Newton step.

 \begin{IEEEeqnarray}{rCl}
 \left[\mat{L} + \mat{N}(\dot{\vec{M}}_{k})\right]\dot{\vec{M}}_{k+1} & = & - \left[\vec{E} + \mat{L}\;\dot{\vec{M}}_{k} + \vec{b}\Delta \text{P}_{k} + \vec{N}(\vec{x}_{k}) \right] \nonumber \\
 & & - \vec{b}\delta(\Delta \text{P}) + \mat{L}\;\dot{\vec{M}}_{k} + \mat{N}(\dot{\vec{M}}_{k})\;\dot{\vec{M}}_{k} \nonumber \\
 \left[\mat{L} + \mat{N}(\dot{\vec{M}}_{k})\right]\dot{\vec{M}}_{k+1} & = & - \vec{F}(\vec{x}_{k}) - \vec{b}\delta(\Delta \text{P}) + \left[\mat{L} + \mat{N}(\dot{\vec{M}}_{k})\right]\;\dot{\vec{M}}_{k} \nonumber \\
 \mat{J}^{*}_{\,k}\,\dot{\vec{M}}_{k+1} & = & - \vec{F}(\vec{x}_{k}) - \vec{b}\delta(\Delta \text{P}) + \mat{J}^{*}_{\,k}\;\dot{\vec{M}}_{k} \nonumber \\
 \mat{J}^{*}_{\,k}\,\left[\dot{\vec{M}}_{k+1}-\dot{\vec{M}}_{k} \right] & = & - \vec{F}(\vec{x}_{k}) - \vec{b}\delta(\Delta \text{P}) \nonumber \\
 \mat{J}^{*}_{\,k}\,\delta(\dot{\vec{M}}) + \vec{b}\delta(\Delta \text{P})  & = & - \vec{F}(\vec{x}_{k})  \nonumber \\
 \mat{J}_{\,k}\,\delta\vec{x} + \vec{b}\delta(\Delta \text{P})  & = & - \vec{F}(\vec{x}_{k})  \nonumber 
 \end{IEEEeqnarray}

 \begin{align}
 \begin{bmatrix} 
 \DerivParOne{\vec{I}_{l}}{\vec{\dot{M}}_{l}} & \DerivParOne{\vec{I}_{l}}{\vec{\dot{M}}_{g}}  & \DerivParOne{\vec{I}_{l}}{\vec{\dot{M}}_{e}} & \DerivParOne{\vec{I}_{l}}{\Delta P}\\
 \DerivParOne{\vec{I}_{g}}{\vec{\dot{M}}_{l}} & \DerivParOne{\vec{I}_{g}}{\vec{\dot{M}}_{g}}  & \DerivParOne{\vec{I}_{g}}{\vec{\dot{M}}_{e}} & \DerivParOne{\vec{I}_{g}}{\Delta P}\\
 \DerivParOne{\vec{I}_{e}}{\vec{\dot{M}}_{l}} & \DerivParOne{\vec{I}_{e}}{\vec{\dot{M}}_{g}}  & \DerivParOne{\vec{I}_{e}}{\vec{\dot{M}}_{e}} & \DerivParOne{\vec{I}_{e}}{\Delta P}
 \end{bmatrix}_{0}
 \cdot
 \begin{bmatrix}
 \Delta \vec{\dot{M}}_l \\
 \Delta \vec{\dot{M}}_g \\
 \Delta \vec{\dot{M}}_e \\
 \Delta P
 \end{bmatrix}_{k\rightarrow k+1} & =
 -\begin{bmatrix}
 \vec{E}_{l} \\
 \vec{E}_{g} \\
 \vec{E}_{e}
 \end{bmatrix} -
 \begin{bmatrix}
 \vec{I}_{l} \\
 \vec{I}_{g} \\
 \vec{I}_{e}
 \end{bmatrix}_{k} \\ 
 % HERE IS A SEPERATE EQUATION
 \begin{bmatrix} 
 \DerivParOne{\vec{I}_{l}}{\vec{\dot{M}}_{l}} & \DerivParOne{\vec{I}_{l}}{\vec{\dot{M}}_{g}}  & \DerivParOne{\vec{I}_{l}}{\vec{\dot{M}}_{e}} \\
 \DerivParOne{\vec{I}_{g}}{\vec{\dot{M}}_{l}} & \DerivParOne{\vec{I}_{g}}{\vec{\dot{M}}_{g}}  & \DerivParOne{\vec{I}_{g}}{\vec{\dot{M}}_{e}} \\
 \DerivParOne{\vec{I}_{e}}{\vec{\dot{M}}_{l}} & \DerivParOne{\vec{I}_{e}}{\vec{\dot{M}}_{g}}  & \DerivParOne{\vec{I}_{e}}{\vec{\dot{M}}_{e}}
 \end{bmatrix}_{0}
 \cdot
 \begin{bmatrix}
 \Delta \vec{\dot{M}}_l \\
 \Delta \vec{\dot{M}}_g \\
 \Delta \vec{\dot{M}}_e
 \end{bmatrix}_{k\rightarrow k+1} & =
 -\vec{E} -
 \vec{I}_{k} -
 \begin{bmatrix}
 \DerivParOne{\vec{I}_{l}}{\Delta P} \\
 \DerivParOne{\vec{I}_{g}}{\Delta P} \\
 \DerivParOne{\vec{I}_{e}}{\Delta P}
 \end{bmatrix}_{0}
 \Delta P_{k \rightarrow k+1} \\
 % HERE IS A SEPERATE EQUATION
 \mat{J}_{\,0}
 \cdot
 \begin{bmatrix}
 \Delta \vec{\dot{M}}_l \\
 \Delta \vec{\dot{M}}_g \\
 \Delta \vec{\dot{M}}_e
 \end{bmatrix}_{k\rightarrow k+1} & =
 -\vec{E} -
 \vec{I}_{k} -
 \vec{p}_{0}
 \Delta P_{k \rightarrow k+1} \\
 % HERE IS A SEPERATE EQUATION
 \begin{bmatrix}
 \Delta \vec{\dot{M}}_l \\
 \Delta \vec{\dot{M}}_g \\
 \Delta \vec{\dot{M}}_e
 \end{bmatrix}_{k\rightarrow k+1} & =
 -\mat{J}_{\,0}^{-1}\left(\vec{E} + \vec{I}_{k}\right) -
 \mat{J}_{\,0}^{-1} \cdot \vec{p}_{0} \Delta P_{k \rightarrow k+1} 
  \end{align}
  \begin{align}
 % HERE IS A SEPERATE EQUATION
 \vec{\dot{M}}^{n+1}_{k+1}- \vec{\dot{M}}^{n+1}_{k} & =
 -\mat{J}_{\,0}^{-1}\left(\vec{E} + \vec{I}_{k}\right) -
 \mat{J}_{\,0}^{-1} \cdot \vec{p}_{0} \Delta P_{k \rightarrow k+1}\\
 % HERE IS A SEPERATE EQUATION
 \vec{\dot{M}}^{n+1}_{k+1} & =
 \underbrace{\vec{\dot{M}}^{n+1}_{k} -\mat{J}_{\,0}^{-1}\left(\vec{E} + \vec{I}_{k}\right)}_{\vec{\dot{M}}^{*}_{k}} - \underbrace{\mat{J}_{\,0}^{-1} \cdot \vec{p}_{0}}_{\frac{\partial \vec{\dot{M}}}{\partial \Delta P}} \Delta P_{k \rightarrow k+1} \\
 % HERE IS A SEPERATE EQUATION
 \vec{\dot{M}}^{n+1}_{k+1} & =
 \underbrace{-\mat{J}_{\,0}^{-1}\cdot \vec{E} + \vec{\dot{M}}^{n+1}_{k} - \mat{J}^{-1}_{\,0}\cdot \vec{I}_{k}}_{\vec{\dot{M}}^{n+1}_{*}} - \underbrace{\mat{J}_{\,0}^{-1} \cdot \vec{p}_{0}}_{\frac{\partial \vec{\dot{M}}}{\partial \Delta P}} \Delta P_{k \rightarrow k+1}
 \end{align}

 \begin{align}
 % HERE IS A SEPERATE EQUATION
 \vec{\dot{m}}^{n+1}_{k+1} & =
 \underbrace{-\mat{J}_{\,0}^{-1}\cdot \vec{E} + \vec{\dot{m}}^{n+1}_{k} - \mat{J}_{\,0}\cdot \vec{I}_{k}}_{\vec{\dot{m}}^{n+1}_{*}} - \underbrace{\mat{J}_{\,0}^{-1} \cdot \vec{p}_{0}}_{\frac{\partial \vec{\dot{m}}}{\partial \Delta P}} \Delta P_{k \rightarrow k+1} \\
 % HERE IS A SEPERATE EQUATION
 \vec{\dot{m}}^{n+1}_{k+1} & =
 \underbrace{-\mat{J}_{\,0}^{-1}\cdot \vec{E} + \vec{\dot{m}}^{n+1}_{k} - \mat{J}_{\,0}\cdot \vec{I}_{k}}_{\vec{\dot{m}}^{n+1}_{*}} - \frac{\partial \vec{\dot{m}}}{\partial \Delta P}\bigg|_{0} \Delta P_{k \rightarrow k+1} \\
 % HERE IS A SEPERATE EQUATION
 \vec{\dot{m}}^{n+1}_{k+1} & =
 \underbrace{-\mat{J}_{\,0}^{-1}\cdot \vec{E} + \left(\mat{I} - \mat{J}^{-1}_{\,0}\cdot \mat{\alpha}_{0}\right)\cdot\vec{x}^{n+1}_{k}}_{\vec{\dot{m}}^{n+1}_{*}} - \frac{\partial \vec{\dot{m}}}{\partial \Delta P}\bigg|_{0} \Delta P_{k \rightarrow k+1}
\end{align}


 \begin{align}
 \Mat{J}_{0} & \equiv -\frac{2 A_{mom}\Delta t}{\Delta z}\cdot \nonumber \\
 &\cdot \begin{bmatrix} 
 K^{n}_{w,l} + \frac{K^{n}_{i,lg}}{\Ave{\alpha\rho}^{n}_{l}} +\frac{1}{2} &  -\frac{K^{n}_{i,lg}}{\Ave{\alpha\rho}^{n}_{g}} & 0\\
 -\frac{K^{n}_{i,lg}}{\Ave{\alpha\rho}^{n}_{l}} &  K^{n}_{w,g} + \frac{K^{n}_{i,lg}}{\Ave{\alpha\rho}^{n}_{g}}+\frac{K^{n}_{i,eg}}{\Ave{\alpha\rho}^{n}_{g}} +\frac{1}{2} & -\frac{K^{n}_{i,eg}}{\Ave{\alpha\rho}^{n}_{e}}\\
 0 & -\frac{K^{n}_{i,eg}}{\Ave{\alpha\rho}^{n}_{g}} &  K^{k}_{w,e} + \frac{K^{n}_{i,eg}}{\Ave{\alpha\rho}^{n}_{e}}+\frac{1}{2}\\
 \end{bmatrix}
 \end{align}