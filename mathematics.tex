%============================================================================
% mathematics.tex
%============================================================================
% This file contains:
% 	- Hydrodynamic Conservation Equations
%	- Structural Thermal Energy Equations
%	- Newton's Method
%	- Jacobian-Free Methodology

%============================================================================
\group{Mathematical Formulation}
% Begin Chapter
%============================================================================
As mentioned earlier, most reactor safety-analysis codes depend upon three discrete sets of physics.
These include, but are not necessarily limited to, two-phase hydrodynamics, heat-transfer between the fluid and a solid structure, and a nuclear power source.
The different physical phenomena are represented by a system of PDEs and ODEs that constitute a set of balance laws for mass, momentum, and energy.
This system encompasses different scales in both space and time.
\pagebreak
%============================================================================
\subgroup{Hydrodynamic Conservation Equations}
% Hydro. Cons. Eqns.
%============================================================================
\begin{minipage}{0.42\textwidth}
\begin{center}\textbf{Conserved Variables}\end{center}
\begin{align}
\Vec{q} & = 
\begin{bmatrix} 
\alpha \rho_g  \\
\alpha \left( \rho_v + \rho_g \right)\\
\left(1-\alpha\right) \rho_l \\
\alpha_e \rho_l \\
\alpha \left( \rho_v + \rho_g \right) \Vec{U}_v \\
\left( 1-\alpha \right) \rho_l \Vec{U}_l \\
\alpha_e \rho_l \Vec{U}_e \\
\alpha \left( \rho_v H_v+ \rho_g H_g \right)\\
\left( 1 -\alpha \right) \rho_l H_l
\end{bmatrix} 
\end{align}
\end{minipage}
\begin{minipage}{0.42\textwidth}
\begin{center}\textbf{Independent Variables}\end{center}
\begin{align}
\Vec{x} & = \begin{bmatrix}
\alpha \\
\alpha_e \\
P \\
\alpha P_g \\
\alpha \left( \rho_v + \rho_g \right) \Vec{U}_v \\
\left( 1-\alpha \right) \rho_l \Vec{U}_l \\
\alpha_e  \rho_l \Vec{U}_e \\
\alpha H_v \\
\left( 1-\alpha \right) H_l
\end{bmatrix}
\end{align}
\end{minipage}

Note that $\displaystyle \Vec{q}=f(\Vec{x})$.

\subsubgroup{Mass}
\begin{align}
\Ddt{\alpha   \rho_v}{\Vec{U}_v} & =  \Gamma   + \DivOne{\Vec{G}_v^{T}}\\
\Ddt{\alpha   \rho_g}{\Vec{U}_v} & =  \Gamma   + \DivOne{\Vec{G}_g^{T}}\\
\Ddt{\alpha_l \rho_l}{\Vec{U}_l} & = -\Gamma_l + \DivOne{\Vec{G}_l^{T}} - S''' \\
\Ddt{\alpha_e \rho_l}{\Vec{U}_e} & = -\Gamma_e + S'''
\end{align}

\subsubgroup{Momentum}

\begin{align}
\Ddt{\alpha \rho_g \Vec{U}_g }{\Vec{U}_g} & = \nonumber \\
-\alpha\;\nabla P + \alpha \rho_g g - \tau^{'''}_{wv}-\tau^{'''}_{I_{lv}}-\tau^{'''}_{I_{ev}}+\Gamma_e U^{'}+\Div{\alpha T_g^{T}} & \\
\Ddt{\alpha_e \rho_l \Vec{U}_e}{\Vec{U}_e} & = \nonumber \\
-\alpha_e\;\nabla P + \alpha_e \rho_l g - \tau^{'''}_{wl}+\tau^{'''}_{ev}+\Gamma_e U^{'}+S^{'''}U^{'} & \\
\Ddt{\alpha_l \rho_l \Vec{U}_l}{\Vec{U}_l} & = \nonumber \\
-\alpha_l\;\nabla P + \alpha_l \rho_l g - \tau^{'''}_{wl}+\tau^{'''}_{lv}-\Gamma_l U^{'}-S^{'''}U^{'}+\Div{\alpha_l T_l^{T}} &
\end{align}

\begin{align}
\DisDdtOne{\dot{\Vec{m}}_{i,j}} & = \min(A_{j},A_{j+1})\frac{1}{2}\left(\frac{\dot{\Vec{m}}_{i,j}^{n}}{A_{j}}+\frac{\dot{\Vec{m}}_{i,j+1}^{n}}{A_{j+1}}\right)\hat{\Vec{U}}_{i,j-\frac{1}{2}}^{n} 
\end{align}

\subsubgroup{Energy}

\begin{align}
\Ddt{\alpha \rho_g H_g}{\Vec{U}_g} & \nonumber \\
= \Gamma H^{'}_{v}+q_{iv}+q_{gl}+Q_g^{'''}-\Div{\alpha \Vec{q}_g^{T}} &\\
\DerivPar{\left(1-\alpha \right)\rho_l H_l}{t}+\Div{\alpha_l \rho_l H_l \Vec{U}_l} +\Div{\alpha_e \rho_l H_l \Vec{U}_e} & = \nonumber \\
-\Gamma H^{'}_l + q_{il} - q_{gl} + Q_l^{'''}-\Div{\alpha_l \Vec{q}_l^{T}} &
\end{align}
%============================================================================
\subgroup{Discrete Hydrodynamic Equations}
% Hydro. Cons. Eqns.
\pagebreak
%============================================================================
\subsubgroup{Axial Momentum}

\begin{IEEEeqnarray}{rCl}
F_g(\Vec{x}^{n+1}) & = & \overbrace{E_g({\Vec{x}^{n}})}^{\text{Purely explicit terms}}-\overbrace{A_{mom,j}\Delta z_j\left[ \alpha_g^n\frac{P_{J+1}^{n+1}-P_{J}^{n+1}}{\Delta z_j}\right]}^{\text{Semi-Implicit Pressure Term}}  \\
& - & \overbrace{A_{mom,j}\Delta z_j\left[ \frac{dP}{dz}\bigg|_{w,g}^{*}+\frac{dP}{dz}\bigg|_{i,lg}^{*}+\frac{dP}{dz}\bigg|_{i,eg}^{*}\right]}^{\text{Semi-Implicit Drag Terms}}\nonumber \\
& + & \overbrace{\mathcal{S}p^{n+1}_{g,j}}^{\text{Implicit Source Term}} -\overbrace{\frac{\left(M_{g,j}^{n+1}-M_{g,j}^{n}\right)}{\Delta t}\Delta z}^{\text{Time rate of change}}\nonumber \\
& = &  0 \nonumber
\end{IEEEeqnarray}

Current methodology in COBRA-IE for obtaining tentative newtime $\dot{\vec{M}}^{\widetilde{n+1}}$ and $\displaystyle \frac{d\dot{\vec{M}}}{d P}$.
This methodology is based on linearizing certain terms within the momentum equations.
These  equations are solved for the $\dot{\vec{M}}^{\widetilde{n+1}}$.
The derivative of these equations with respect to pressure is taken to find $\displaystyle \frac{d\dot{\vec{M}}}{d P}$.
\begin{IEEEeqnarray}{rCl}
\mat{J}_{0}\,\dot{\vec{M}}^{\widetilde{n+1}} & = & -\vec{E} - \vec{I}(\dot{\vec{M}}^{n}) + \dot{\vec{M}}^{n} \nonumber \\
\dot{\vec{M}}^{\widetilde{n+1}} & = & -\mat{J}^{-1}_{\,0}\,\vec{E} - \mat{J}^{-1}_{\,0}\,\vec{I}(\dot{\vec{M}}^{n}) + \mat{J}^{-1}_{\,0}\,\dot{\vec{M}}^{n} \nonumber
\end{IEEEeqnarray}

Proposed methodology for obtaining tentative newtime $\dot{\vec{M}}^{\widetilde{n+1}}$ and $\displaystyle \frac{d\dot{\vec{M}}}{d P}$.
This methodology is based on linearizing the the equations and taking a Newton Step.
\begin{IEEEeqnarray}{rCl}
\mat{J}_{0}\,\left[\dot{\vec{M}}^{n+1}_{k+1}-\dot{\vec{M}}^{n+1}_{k}\right] & = & -\vec{E} - \vec{I}(\dot{\vec{M}}^{n+1}_{k}) \nonumber \\
\dot{\vec{M}}^{n+1}_{k+1} & = & \dot{\vec{M}}^{n+1}_{k} - \mat{J}^{-1}_{0}\,\vec{E} - \mat{J}^{-1}_{0}\,\vec{I}(\dot{\vec{M}}^{n+1}_{k}) \nonumber
\end{IEEEeqnarray}

Difference between current process and new process.
\begin{IEEEeqnarray}{rCl}
\dot{\vec{M}}^{n+1}_{k+1} - \dot{\vec{M}}^{\widetilde{n+1}}_{k+1} & = & \dot{\vec{M}}^{n+1}_{k} - \mat{J}^{-1}_{0}\,\vec{I}(\dot{\vec{M}}^{n+1}_{k}) + \mat{J}^{-1}_{\,0}\,\vec{I}(\dot{\vec{M}}^{n}) - \mat{J}^{-1}_{\,0}\,\dot{\vec{M}}^{n}\nonumber \\
\dot{\vec{M}}^{n+1}_{1} - \dot{\vec{M}}^{\widetilde{n+1}}_{1} & = & \dot{\vec{M}}^{n} - \mat{J}^{-1}_{\,0}\,\dot{\vec{M}}^{n}\nonumber \\
\dot{\vec{M}}^{n+1}_{1} & = & \dot{\vec{M}}^{\widetilde{n+1}}_{1} + [\mat{I} - \mat{J}^{-1}_{\,0}]\,\dot{\vec{M}}^{n} \nonumber \\
\dot{\vec{M}}^{n+1}_{2} - \dot{\vec{M}}^{\widetilde{n+1}}_{2} & = & \dot{\vec{M}}^{n+1}_{1} - \mat{J}^{-1}_{0}\,\vec{I}(\dot{\vec{M}}^{n+1}_{1}) + \mat{J}^{-1}_{\,0}\,\vec{I}(\dot{\vec{M}}^{n+1}_{1}) - \mat{J}^{-1}_{\,0}\,\dot{\vec{M}}^{n+1}_{1}\nonumber \\
\dot{\vec{M}}^{n+1}_{2} & = & \dot{\vec{M}}^{\widetilde{n+1}}_{2} + [\mat{I} - \mat{J}^{-1}_{\,0}]\dot{\vec{M}}^{n+1}_{1}\nonumber \\
\dot{\vec{M}}^{n+1}_{k+1} & = & \dot{\vec{M}}^{\widetilde{n+1}}_{k+1} + [\mat{I} - \mat{J}^{-1}_{\,0}]\dot{\vec{M}}^{n+1}_{k} \nonumber
\end{IEEEeqnarray}

The nonlinear functional associated with this equation is as follows:

\begin{IEEEeqnarray}{rCl}
\overbrace{\FVS{F}{\Vec{M}^{n+1},\;P^{n+1}}}^{\text{Nonlinear Functional}} & = & 0 \nonumber \\
& = & \underbrace{\FVS{E}{\Vec{M}^{n}}}_{\text{Explict Terms}} +\underbrace{\FVS{I}{\Vec{M}^{n+1},\;P^{n+1}}}_{\text{Implicit Terms}}\nonumber
\end{IEEEeqnarray}
\begin{IEEEeqnarray}{rCl}
\Vec{x}^{n+1} & = & \begin{bmatrix} M_l^{n+1}\\M_g^{n+1}\\M_e^{n+1}\\P^{n+1}\end{bmatrix} \nonumber \\
\FVS{F}{\Vec{x}^{n+1}} & = & \FVS{E}{\Vec{x}^n}+\FVS{I}{\Vec{x}^{n+1}} \nonumber
\end{IEEEeqnarray}

Now, this nonlinear functional is solved using a Newton Step.

\begin{IEEEeqnarray}{rCl}
\Vec{F}(\Vec{x}_{k+1}^{n+1}) = \Vec{F}(\Vec{x}_{k}^{n+1}) + \Mat{J}\cdot\Vec{\delta x}_{k} & = & 0\nonumber \\
\Vec{\delta x}_k & =&  \Vec{x}^{n+1}_{k+1}-\Vec{x}^{n+1}_{k} \nonumber \\
\Vec{F}(\Vec{x}_{k}^{n+1}) + \Mat{J} \cdot\Vec{\delta x}_{k} & = & 0 \nonumber \\
\Mat{J} \cdot\Vec{\delta x}_{k} & = & -\Vec{F}(\Vec{x}_{k}^{n+1}) \nonumber
\end{IEEEeqnarray}

\begin{align}
\begin{bmatrix} 
\DerivParOne{\vec{I}_{l}}{\vec{\dot{m}}_{l}} & \DerivParOne{\vec{I}_{l}}{\vec{\dot{m}}_{g}}  & \DerivParOne{\vec{I}_{l}}{\vec{\dot{m}}_{e}} & \DerivParOne{\vec{I}_{l}}{\Delta P}\\
\DerivParOne{\vec{I}_{g}}{\vec{\dot{m}}_{l}} & \DerivParOne{\vec{I}_{g}}{\vec{\dot{m}}_{g}}  & \DerivParOne{\vec{I}_{g}}{\vec{\dot{m}}_{e}} & \DerivParOne{\vec{I}_{g}}{\Delta P}\\
\DerivParOne{\vec{I}_{e}}{\vec{\dot{m}}_{l}} & \DerivParOne{\vec{I}_{e}}{\vec{\dot{m}}_{g}}  & \DerivParOne{\vec{I}_{e}}{\vec{\dot{m}}_{e}} & \DerivParOne{\vec{I}_{e}}{\Delta P}
\end{bmatrix}_{0}
\cdot
\begin{bmatrix}
\Delta \vec{\dot{m}}_l \\
\Delta \vec{\dot{m}}_g \\
\Delta \vec{\dot{m}}_e \\
\Delta P
\end{bmatrix}_{k\rightarrow k+1} & =
-\begin{bmatrix}
\vec{E}_{l} \\
\vec{E}_{g} \\
\vec{E}_{e}
\end{bmatrix} -
\begin{bmatrix}
\vec{I}_{l} \\
\vec{I}_{g} \\
\vec{I}_{e}
\end{bmatrix}_{k} \\ 
% HERE IS A SEPERATE EQUATION
\begin{bmatrix} 
\DerivParOne{\vec{I}_{l}}{\vec{\dot{m}}_{l}} & \DerivParOne{\vec{I}_{l}}{\vec{\dot{m}}_{g}}  & \DerivParOne{\vec{I}_{l}}{\vec{\dot{m}}_{e}} \\
\DerivParOne{\vec{I}_{g}}{\vec{\dot{m}}_{l}} & \DerivParOne{\vec{I}_{g}}{\vec{\dot{m}}_{g}}  & \DerivParOne{\vec{I}_{g}}{\vec{\dot{m}}_{e}} \\
\DerivParOne{\vec{I}_{e}}{\vec{\dot{m}}_{l}} & \DerivParOne{\vec{I}_{e}}{\vec{\dot{m}}_{g}}  & \DerivParOne{\vec{I}_{e}}{\vec{\dot{m}}_{e}}
\end{bmatrix}_{0}
\cdot
\begin{bmatrix}
\Delta \vec{\dot{m}}_l \\
\Delta \vec{\dot{m}}_g \\
\Delta \vec{\dot{m}}_e
\end{bmatrix}_{k\rightarrow k+1} & =
-\vec{E} -
\vec{I}_{k} -
\begin{bmatrix}
\DerivParOne{\vec{I}_{l}}{\Delta P} \\
\DerivParOne{\vec{I}_{g}}{\Delta P} \\
\DerivParOne{\vec{I}_{e}}{\Delta P}
\end{bmatrix}_{0}
\Delta P_{k \rightarrow k+1} \\
% HERE IS A SEPERATE EQUATION
\mat{J}_{\,0}
\cdot
\begin{bmatrix}
\Delta \vec{\dot{m}}_l \\
\Delta \vec{\dot{m}}_g \\
\Delta \vec{\dot{m}}_e
\end{bmatrix}_{k\rightarrow k+1} & =
-\vec{E} -
\vec{I}_{k} -
\vec{p}_{0}
\Delta P_{k \rightarrow k+1} \\
% HERE IS A SEPERATE EQUATION
\begin{bmatrix}
\Delta \vec{\dot{m}}_l \\
\Delta \vec{\dot{m}}_g \\
\Delta \vec{\dot{m}}_e
\end{bmatrix}_{k\rightarrow k+1} & =
-\mat{J}_{\,0}^{-1}\left(\vec{E} + \vec{I}_{k}\right) -
\mat{J}_{\,0}^{-1} \cdot \vec{p}_{0} \Delta P_{k \rightarrow k+1} \\
% HERE IS A SEPERATE EQUATION
\vec{\dot{m}}^{n+1}_{k+1}- \vec{\dot{m}}^{n+1}_{k} & =
-\mat{J}_{\,0}^{-1}\left(\vec{E} + \vec{I}_{k}\right) -
\mat{J}_{\,0}^{-1} \cdot \vec{p}_{0} \Delta P_{k \rightarrow k+1}\\
% HERE IS A SEPERATE EQUATION
\vec{\dot{m}}^{n+1}_{k+1} & =
\underbrace{\vec{\dot{m}}^{n+1}_{k} -\mat{J}_{\,0}^{-1}\left(\vec{E} + \vec{I}_{k}\right)}_{\vec{\dot{m}}^{*}_{k}} - \underbrace{\mat{J}_{\,0}^{-1} \cdot \vec{p}_{0}}_{\frac{\partial \vec{\dot{m}}}{\partial \Delta P}} \Delta P_{k \rightarrow k+1} \\
% HERE IS A SEPERATE EQUATION
\vec{\dot{m}}^{n+1}_{k+1} & =
\underbrace{-\mat{J}_{\,0}^{-1}\cdot \vec{E} + \vec{\dot{m}}^{n+1}_{k} - \mat{J}^{-1}_{\,0}\cdot \vec{I}_{k}}_{\vec{\dot{m}}^{n+1}_{*}} - \underbrace{\mat{J}_{\,0}^{-1} \cdot \vec{p}_{0}}_{\frac{\partial \vec{\dot{m}}}{\partial \Delta P}} \Delta P_{k \rightarrow k+1}
\end{align}

\begin{align}
% HERE IS A SEPERATE EQUATION
\vec{\dot{m}}^{n+1}_{k+1} & =
\underbrace{-\mat{J}_{\,0}^{-1}\cdot \vec{E} + \vec{\dot{m}}^{n+1}_{k} - \mat{J}_{\,0}\cdot \vec{I}_{k}}_{\vec{\dot{m}}^{n+1}_{*}} - \underbrace{\mat{J}_{\,0}^{-1} \cdot \vec{p}_{0}}_{\frac{\partial \vec{\dot{m}}}{\partial \Delta P}} \Delta P_{k \rightarrow k+1} \\
% HERE IS A SEPERATE EQUATION
\vec{\dot{m}}^{n+1}_{k+1} & =
\underbrace{-\mat{J}_{\,0}^{-1}\cdot \vec{E} + \vec{\dot{m}}^{n+1}_{k} - \mat{J}_{\,0}\cdot \vec{I}_{k}}_{\vec{\dot{m}}^{n+1}_{*}} - \frac{\partial \vec{\dot{m}}}{\partial \Delta P}\bigg|_{0} \Delta P_{k \rightarrow k+1} \\
% HERE IS A SEPERATE EQUATION
\vec{\dot{m}}^{n+1}_{k+1} & =
\underbrace{-\mat{J}_{\,0}^{-1}\cdot \vec{E} + \left(\mat{I} - \mat{J}^{-1}_{\,0}\cdot \mat{\alpha}_{0}\right)\cdot\vec{x}^{n+1}_{k}}_{\vec{\dot{m}}^{n+1}_{*}} - \frac{\partial \vec{\dot{m}}}{\partial \Delta P}\bigg|_{0} \Delta P_{k \rightarrow k+1}
\end{align}


\begin{align}
\Mat{J}_{0} & \equiv -\frac{2 A_{mom}\Delta t}{\Delta z}\cdot \nonumber \\
&\cdot \begin{bmatrix} 
K^{n}_{w,l} + \frac{K^{n}_{i,lg}}{\Ave{\alpha\rho}^{n}_{l}} +\frac{1}{2} &  -\frac{K^{n}_{i,lg}}{\Ave{\alpha\rho}^{n}_{g}} & 0\\
-\frac{K^{n}_{i,lg}}{\Ave{\alpha\rho}^{n}_{l}} &  K^{n}_{w,g} + \frac{K^{n}_{i,lg}}{\Ave{\alpha\rho}^{n}_{g}}+\frac{K^{n}_{i,eg}}{\Ave{\alpha\rho}^{n}_{g}} +\frac{1}{2} & -\frac{K^{n}_{i,eg}}{\Ave{\alpha\rho}^{n}_{e}}\\
0 & -\frac{K^{n}_{i,eg}}{\Ave{\alpha\rho}^{n}_{g}} &  K^{k}_{w,e} + \frac{K^{n}_{i,eg}}{\Ave{\alpha\rho}^{n}_{e}}+\frac{1}{2}\\
\end{bmatrix}
\end{align}

\subsubgroup{Linearization}
The semi-implicit method, with a single Newton Step linearizes about the old time value and solves for a single delta. This has several ramifications.

\subsubsubgroup{Wall Drag}
The beginning equation to formulate the wall drag is shown in Eqn.

\begin{IEEEeqnarray}{rCl}
\frac{dP}{dz}\bigg\vert^{n+1}_{k} & \equiv & \left(\frac{f^{n}}{D_h}+\frac{K_{form}}{\Delta z}\right) \left(\frac{1}{2 \rho^{n}}\right) \left(\frac{\dot{\vec{m}}^{n+1}_{k}}{A_{mom}}\right)^{2}\\
 & = & \left[\left(\frac{f^{n}}{D_h}+\frac{K_{form}}{\Delta z}\right) \left(\frac{1}{2 A^2_{mom} \rho^{n}}\right)\right] \left[\dot{\vec{m}}^{n+1}_{k}\right]^2\\
  & = & \left[K^{n}\right] \left[\dot{\vec{m}}^{n+1}_{k}\right]^2\\
\frac{\partial }{\partial_{\dot{\vec{m}}^{n+1}_{k}}} \left(\frac{dP}{dz}\bigg\vert^{n+1}_{k}\right) & = & \left[K^{n}\right]2\left[ \dot{\vec{m}}_{k}^{n+1}\right]
\end{IEEEeqnarray}

The Momentum Equations, outlined in Section \ref{blarp} contain an implicit wall drag. This means that we need to evaluate the wall drag at the future time value.
To do this in the semi-implicit methodology requires that we linearize the future value using Newton's Method.
The current implementation uses the following derivation.

Modifying this derivation to take into account the multiple Newton Steps results in the equations shown below.
For brevity, the phase index, $_k$, is dropped from this derivation.
Once the linearization starts, the index, $_k$, will refer to Newton iteration.

%============================================================================
\subgroup{Structural Thermal Energy Equations}
% Heat Structures
%============================================================================

%============================================================================
\subgroup{Newton's Method}
% Newton's Method
%============================================================================

COBRA currently uses a single linearized Newton step to solve the hydrodynamic equations.
This method has been shown to be adequate \ref{blarp} given a small enough time step.
One potential improvement that can be made to the current method is multiple Newton steps being taken with a frozen Jacobian.
The Jacobian will be evaluated at the old time value and not updated during the Newton process.


%============================================================================
\subgroup{Krylov Solvers}
% Krylov Solvers
%============================================================================
To solve a give newton iteraete, a Krylov subspace based method is used.
This methodology eliminates the requirement of analytically forming the Jacobian.